{% extends "main.html" %}
{% block content %}
{% include "header.html" %}
<style>
  #results-count h1 {
    margin-bottom: 0;
  }

  .pagination {
    display: inline-flex;
  }

  .pagination ul {
    list-style-type: none;
    margin-bottom: 0;
  }

  .pagination li {
    display: inline-block;
    margin-right: 5px;
    cursor: pointer;
  }

  #pagination-page-size li {
    margin-right: 25px;
  }

  .result-summary {
    border-bottom: 1px solid #BBB;
  }

  .selected {
    font-weight: bold;
  }

  .unselected {
    font-weight: 300;
  }

  .disabled {
    opacity: 0.5;
  }

  .keyword,
  .measurement {
    padding: 3px 5px;
    border-radius: 0.3em;
    margin-left: 0.5em;
    margin-bottom: 0.5em;
    font-size: 0.75em;
    cursor: pointer;
  }

  .keyword {
    background: #63296b31;
  }

  .measurement {
    background: #4a7d8f31;
  }

  .dataset-properties {
    font-size: 0.85em;
  }

  .citation {
    color: #4a7d8f;
    line-height: 1.2em;
  }

  #credit {
    border-bottom: 1px dashed #bbb;
    padding-bottom: 2px;
    margin-bottom: 5px;
    flex-direction: column;
  }
</style>
<div id="search-results" class="container d-flex" style="min-height:100vh">
  <div v-if=loading class="loader">
    <img src="/static/img/ripple.svg" />
  </div>

  <div class="jumbotron bg-light text-muted w-100">
    <form class="row" @submit.prevent="search(query)">
      <input id="search-query" type="text" v-model='query' name="query" class="form-control mb-4 col-lg-4 col-md-6" placeholder="search datasets">
    </form>

    <div id="results-count" class="d-flex align-items-center justify-content-between" v-if="results">
      <h1 id="num-results">
        <span v-text=numResults>
        </span><span> results</span>
      </h1>

      <div id="pagination-page-size" class="pagination">
        Show
        <ul>
          <li v-for="(pageSize, index) in paginationOptions" v-if="pageSize <= numResults || index === 0 || paginationOptions[index-1] < numResults" v-bind:class="[ pageSize === selectedPerPage ? 'selected' : 'unselected' ]">
            <a v-text="pageSize" v-on:click="changePageSize(pageSize)"></a>
          </li>
        </ul>
      </div>

    </div>


    <template v-show="results && results.length > 0">

      <nav class="m-auto d-flex justify-content-center" v-if="results && results.length > 0" id="pagination">
        <ul class="pagination m-2 flex-wrap p-2">
          <li class="page-item" :class="{ 'disabled': selectedPage <= 1 }">
            <a class="page-link" @click.prevent="prevPage()">&lt;</a>
          </li>
          <li class="page-item" :class="{ 'active': selectedPage == 1, 'bg-primary': selectedPage == 1, 'white-text': selectedPage == 1  }">
            <a href="#" class="page-link" @click.prevent="changePageNumber(1)">1</a>
          </li>
          <li class="page-item disabled" v-if="selectedPage > 3 && pages > 4">
            ...
          </li>
          <li class="page-item" :class="{ 'active': selectedPage == n, 'bg-primary': selectedPage == n, 'white-text': selectedPage == n  }" v-for="n in pages"
            v-if="n !== 1 && n !== pages && ((n >= selectedPage - 1 && n <= selectedPage + 1) || (n <=4 && selectedPage <= n) || (n >= pages - 3 && selectedPage >= pages - 1))">
            <a href="#" class="page-link" @click.prevent="changePageNumber(n)" v-text="n"></a>
          </li>
          <li class="page-item disabled" v-if="(selectedPage < pages - 2) && pages > 4">
            ...
          </li>
          <li class="page-item" :class="{ 'active': selectedPage == pages, 'bg-primary': selectedPage == pages, 'white-text': selectedPage == pages  }" v-if="pages !== 1">
            <a href="#" class="page-link" @click.prevent="changePageNumber(pages)" v-text="pages"></a>
          </li>
          <li class="page-item" :class="{ 'disabled': selectedPage >= pages }">
            <a class="page-link" @click.prevent="nextPage()">&gt;</a>
          </li>
        </ul>
      </nav>


      <div v-for="item in results" class="row py-3 result-summary">
        <div class="col-md-4 text-left">
          <!-- name -->
          <a :href="'/dataset/' + item._id">
            <h5 v-text="item.name" class="row"></h5>
          </a>

          <!-- other short properties -->
          <div class="dataset-properties">
            <div id="credit" class="row" v-if="item.creator || item.publisher || item.provider">

              <div id="creator" v-if="item.creator">
                <template v-if="Array.isArray(item.creator)  && item.creator.length > 0">
                  <span v-text="item.creator[0].name"></span><i> et al.</i>

                </template>
                <template v-else>
                  <span v-text="item.creator.name"></span>
                </template>
              </div>
              <div id="author" v-else-if="item.author">
                <template v-if="Array.isArray(item.author) && item.author.length > 0">
                  <span v-text="item.author[0].name"></span><i> et al.</i>

                </template>
                <template v-else>
                  <span v-text="item.author.name"></span>
                </template>
              </div>

              <!-- <div id="creator-affiliation" v-text="item.creator[0].affiliation" v-if="item.creator && item.creator[0].affiliation">
              </div>
              <div id="creator-affiliation" v-text="item.author[0].affiliation" v-else-if="item.author && item.author[0] && item.author[0].affiliation">
              </div> -->
              <div id="publisher" v-text="item.publisher.name" v-else-if="item.publisher"></div>
              <div id="provider" v-text="item.provider.name" v-else-if="item.provider"></div>

              <div id="citation" class="citation" v-if="item.citation">
                <template v-if="Array.isArray(item.citation)">
                  <span v-for="citation in item.citation" v-text="citation"></span>
                </template>
                <template v-else>
                  <span v-text="item.citation"></span>
                </template>
              </div>

            </div>

            <div id="source">
              <template v-if="item['_id'].includes('zenodo')">
                view on <a :href="item.url" target="_blank" rel="noreferrer">Zenodo</a>
              </template>

              <template v-if="item['_id'].includes('omicsdi')">
                view on <a :href="item['_id']" target="_blank" rel="noreferrer">OmicsDI</a>
              </template>
              <template v-if="item.includedInDataCatalog && item.includedInDataCatalog.name.includes('NCBI GEO')">
                view on <a :href="item.distribution.contentUrl" target="_blank" rel="noreferrer">NCBI GEO</a>
              </template>
              <template v-if="item.includedInDataCatalog && item.includedInDataCatalog.name.includes('Harvard Dataverse')">
                view on <a :href="item['@id']" target="_blank" rel="noreferrer">Harvard Dataverse</a>
              </template>
            </div>


            <div id="dateModified" v-if="item.dateModified"><span style="padding-right:4px">updated</span><span v-text="item.dateModified"></span></div>
            <!-- <div id="dateModified" class="row" v-if="item.dateModified | moment('dddd, MMMM Do YYYY')"><span style="padding-right:4px">updated</span><span v-text="item.dateModified"></span></div> -->
            <div id="datePublished" v-if="item.datePublished"><span style="padding-right:4px">published</span><span v-text="item.datePublished"></span></div>

            <div id="license" v-if="item.license && item.license.text">
              <a target="_blank" :href="'/'+item.license.url+'/'" v-text="item.license.text">link</a>
            </div>
          </div>
        </div>

        <!-- description -->
        <div class="col-md-8 text-left" id="description">
          <template v-if="Array.isArray(item.description)">
            <div v-for="description in item.description" v-html="description"></div>
          </template>
          <div v-html="item.description" v-else></div>
        </div>

        <!-- measurementTechnique -->
        <div class="col-md-12">
          <div class="row d-flex justify-content-end" id="variableMeasured" v-if="item.variableMeasured || item.measurementTechnique">
            <!-- variableMeasured -->
            <template v-if="Array.isArray(item.variableMeasured)">
              <small class="measurement" v-text="measurement" v-for="measurement in item.variableMeasured" @click.prevent="search(measurement, true, true)">
              </small>
            </template>
            <small class="measurement" v-else v-text="item.variableMeasured" v-if="item.variableMeasured" @click.prevent="search(item.variableMeasured, true, true)">
            </small>

            <!-- measurementTechnique -->
            <template v-if="Array.isArray(item.measurementTechnique)">
              <small class="measurement" v-text="measurement" v-for="measurement in item.measurementTechnique" @click.prevent="search(measurement, true, true)">
              </small>
            </template>
            <small class="measurement" v-else v-text="item.measurementTechnique" v-if="item.measurementTechnique" @click.prevent="search(item.measurementTechnique, true, true)">
            </small>
          </div>
        </div>

        <!-- keywords -->
        <div class="col-md-12">
          <div class="row d-flex justify-content-end" id="keywords" v-if="item.keywords">
            <template v-if="Array.isArray(item.keywords)">
              <small class="keyword" v-text="keyword" v-for="keyword in item.keywords" @click.prevent="search(keyword, true, true)">
              </small>
            </template>
            <small class="keyword" v-text="item.keywords" @click.prevent="search(item.keywords, true, true)" v-else>
            </small>
          </div>
        </div>
      </div>

    </template>


  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/vuex"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.4.2/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
<!-- <script src="https://unpkg.com/tippy.js@3/dist/tippy.all.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/sweetalert2@7.28.11/dist/sweetalert2.all.min.js"></script> -->
<script>
  const store = new Vuex.Store({
    state: {
      'metadata': {},
    },
    strict: true,
    mutations: {
      saveMetadata(state, payload) {
        state.metadata = payload['metadata']
      },
    },
    getters: {
      // exposed as store.getters.nameOfGetter
      getMetadata: state => {
        return state.metadata
      },
    }
  });

  var app = new Vue({
    el: '#search-results',
    data: function() {
      return {
        query: "ebola",
        loading: false,
        paginationOptions: [10, 25, 50],
        defaultPerPage: 10,
        selectedPerPage: 10,
        selectedPage: 1,
        numResults: 0,
        results: [],
        pages: 1,
        query: '',
        loading: false,
        scripttext: ''
      }
    },
    methods: {
      changePageSize(selectedSize) {
        let self = this;
        self.selectedPerPage = selectedSize;

        self.search(self.query, false);
      },
      changePageNumber(pageNumber) {
        let self = this;
        self.selectedPage = pageNumber;

        self.search(self.query, false);
      },
      calculatePages: function() {
        var self = this;
        self.pages = Math.ceil(self.numResults / self.selectedPerPage);
      },
      prevPage: function() {
        var self = this;
        if (self.selectedPage > 1)
          self.selectedPage -= 1
        self.search(self.query, false);
      },
      nextPage: function() {
        var self = this;
        if (self.selectedPage < self.pages)
          self.selectedPage += 1
        self.search(self.query, false);
      },
      search(query, isNewQuery = true, enquoteQuery = false) {
        var self = this;
        // reset pagination if there's a new query
        if (isNewQuery) {
          self.query = query;
          self.selectedPerPage = self.defaultPerPage;
          self.selectedPage = 1;
        }

        query = query ? (enquoteQuery ? `"${query}"` : query) : "__all__";

        if (query) {
          var params = {
            "params": {
              "q": query,
              "size": self.selectedPerPage,
              "from": (self.selectedPage - 1) * self.selectedPerPage,
            }
          };
        }
        console.log(params)


        self.loading = true;

        self.registry = []; <!--TODO: set in config-- >
          axios.get('http://su07:8080/api/query?', params).then(function(response) {
            console.log(`%c searching ${query}...`, 'color:hotpink')
            console.log(response)
            console.log(response.data.hits)
            self.results = response.data.hits;
            self.numResults = response.data.total.value;
            let maxPage = Math.ceil(self.numResults / self.selectedPerPage)

            if (self.numResults) {
              self.calculatePages();
            }

            self.loading = false;
          });
      }
    }
  });
</script>
{% include "footer.html" %}
{% endblock %}
