{% extends "main.html" %}
{% block content %}
{% include "header.html" %}
<style>
  #pagination-page-size {
    display: inline-flex;
  }

  #pagination-page-size ul {
    list-style-type: none;
  }

  #pagination-page-size li {
    display: inline-block;
    margin-right: 25px;
    cursor: pointer;
  }

  .result-summary {
    border-bottom: 1px solid #BBB;
  }

  .keyword,
  .measurement {
    padding: 3px 5px;
    border-radius: 0.3em;
    margin-left: 0.5em;
    margin-bottom: 0.5em;
    font-size: 0.75em;
  }

  .keyword {
    background: #63296b31;
  }

  .measurement {
    background: #4a7d8f31;
  }

  .dataset-properties {
    font-size: 0.85em;
  }

  .citation {
    color: #4a7d8f;
    line-height: 1.2em;
  }

  #credit {
    border-bottom: 1px dashed #bbb;
    padding-bottom: 2px;
    margin-bottom: 5px;
    flex-direction: column;
  }
</style>
<div id="search-results" class="container d-flex" style="min-height:100vh">
  <div v-if=loading class="loader">
    <img src="/static/img/ripple.svg" />
  </div>

  <div class="jumbotron bg-light text-muted w-100">
    <form class="row" @submit.prevent="search(query)">
      <input id="search-query" type="text" v-model='query' name="query" class="form-control mb-4 col-lg-4 col-md-6" placeholder="search datasets">
    </form>

    <div id="results-count" class="d-flex justify-content-between" v-if="results">
      <h1 id="num-results">
        <span v-text=numResults>
        </span><span> results</span>
      </h1>

      <div id="pagination-page-size">
        Show
        <ul>
          <li v-for="(pageSize, index) in paginationOptions" v-if="pageSize <= numResults || index === 0">
            <a v-text="pageSize"></a>
          </li>
        </ul>
      </div>

    </div>


    <template v-show="results && results.length > 0">
      <div v-for="item in results" class="row py-3 result-summary">
        <div class="col-md-4 text-left">
          <!-- name -->
          <a :href="'/dataset/' + item._id">
            <h5 v-text="item.name" class="row"></h5>
          </a>

          <!-- other short properties -->
          <div class="dataset-properties">
            <div id="credit" class="row" v-if="item.creator || item.publisher || item.provider">

              <div id="creator" v-if="item.creator">
                <div v-if="Array.isArray(item.creator)  && item.creator.length > 0">
                  <span v-text="item.creator[0].name"></span><i> et al.</i>

                </div>
                <div v-else>
                  <span v-text="item.creator.name"></span>
                </div>
              </div>
              <div id="author" v-else-if="item.author">
                <div v-if="Array.isArray(item.author) && item.author.length > 0">
                  <span v-text="item.author[0].name"></span><i> et al.</i>

                </div>
                <div v-else>
                  <span v-text="item.author.name"></span>
                </div>
              </div>

              <!-- <div id="creator-affiliation" v-text="item.creator[0].affiliation" v-if="item.creator && item.creator[0].affiliation">
              </div>
              <div id="creator-affiliation" v-text="item.author[0].affiliation" v-else-if="item.author && item.author[0] && item.author[0].affiliation">
              </div> -->
              <div id="publisher" v-text="item.publisher.name" v-else-if="item.publisher"></div>
              <div id="provider" v-text="item.provider.name" v-else-if="item.provider"></div>

              <div id="citation" class="citation" v-if="item.citation">
                <div v-if="Array.isArray(item.citation)">
                  <span v-for="citation in item.citation" v-text="citation"></span> </div>
                <div v-else>
                  <span v-text="item.citation"></span>
                </div>
              </div>

            </div>

            <div id="source">
              <div v-if="item['_id'].includes('zenodo')">
                view on <a :href="item.url" target="_blank" rel="noreferrer">Zenodo</a>
              </div>

              <div v-if="item['_id'].includes('omicsdi')">
                view on <a :href="item['_id']" target="_blank" rel="noreferrer">OmicsDI</a>
              </div>
              <div v-if="item.includedInDataCatalog && item.includedInDataCatalog.name.includes('NCBI GEO')">
                view on <a :href="item.distribution.contentUrl" target="_blank" rel="noreferrer">NCBI GEO</a>
              </div>
              <div v-if="item.includedInDataCatalog && item.includedInDataCatalog.name.includes('Harvard Dataverse')">
                view on <a :href="item['@id']" target="_blank" rel="noreferrer">Harvard Dataverse</a>
              </div>

            </div>


            <div id="dateModified" v-if="item.dateModified"><span style="padding-right:4px">updated</span><span v-text="item.dateModified"></span></div>
            <!-- <div id="dateModified" class="row" v-if="item.dateModified | moment('dddd, MMMM Do YYYY')"><span style="padding-right:4px">updated</span><span v-text="item.dateModified"></span></div> -->
            <div id="datePublished" v-if="item.datePublished"><span style="padding-right:4px">published</span><span v-text="item.datePublished"></span></div>

            <div id="license" v-if="item.license && item.license.text">
              <a target="_blank" :href="'/'+item.license.url+'/'" v-text="item.license.text">link</a>
            </div>
          </div>
        </div>

        <!-- description -->
        <div class="col-md-8 text-left" id="description">
          <div v-if="Array.isArray(item.description)">
            <div v-for="description in item.description" v-html="description"></div>
          </div>
          <div v-html="item.description" v-else></div>
        </div>

        <!-- measurementTechnique -->
        <div class="col-md-12">
          <div class="row d-flex justify-content-end" id="variableMeasured" v-if="item.variableMeasured || item.measurementTechnique">
            <!-- variableMeasured -->
            <div v-if="Array.isArray(item.variableMeasured)">
              <small class="measurement" v-text="measurement" v-for="measurement in item.variableMeasured">
              </small>
            </div>
            <small class="measurement" v-else v-text="item.variableMeasured" v-if="item.variableMeasured">
            </small>

            <!-- measurementTechnique -->
            <div v-if="Array.isArray(item.measurementTechnique)">
              <small class="measurement" v-text="measurement" v-for="measurement in item.measurementTechnique">
              </small>
            </div>
            <small class="measurement" v-else v-text="item.measurementTechnique" v-if="item.measurementTechnique">
            </small>
          </div>
        </div>

        <!-- keywords -->
        <div class="col-md-12">
          <div class="row d-flex justify-content-end" id="keywords" v-if="item.keywords">
            <div v-if="Array.isArray(item.keywords)">
              <small class="keyword" v-text="keyword" v-for="keyword in item.keywords">
              </small>
            </div>
            <small class="keyword" v-text="item.keywords" v-else>
            </small>
          </div>
        </div>
      </div>

    </template>


  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/vuex"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.4.2/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
<!-- <script src="https://unpkg.com/tippy.js@3/dist/tippy.all.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/sweetalert2@7.28.11/dist/sweetalert2.all.min.js"></script> -->
<script>
  const store = new Vuex.Store({
    state: {
      'metadata': {},
    },
    strict: true,
    mutations: {
      saveMetadata(state, payload) {
        state.metadata = payload['metadata']
      },
    },
    getters: {
      // exposed as store.getters.nameOfGetter
      getMetadata: state => {
        return state.metadata
      },
    }
  });

  var app = new Vue({
    el: '#search-results',
    data: function() {
      return {
        query: "ebola",
        loading: false,
        paginationOptions: [10, 25, 50],
        numResults: 0,
        results: [],
        query: '',
        loading: false,
        scripttext: ''
      }
    },
    methods: {
      search(query) {
        var self = this;

        query = query || "__all__";

        if (query) {
          var params = {
            "params": {
              "q": query,
            }
          };
        }
        console.log(params)

        self.loading = true;

        self.registry = [];
        axios.get('http://su07:8080/api/query?size=10', params).then(function(response) {
          console.log(`%c searching ${query}...`, 'color:hotpink')
          console.log(response)
          console.log(response.data.hits)
          self.results = response.data.hits;
          self.numResults = response.data.total.value;

          self.loading = false;
        });
      }
    }
  });
</script>
{% include "footer.html" %}
{% endblock %}
