{% extends "main.html" %}
{% block content %}
{% include "header.html" %}

<div id="search-results" class="container d-flex" style="min-height:100vh">
  <div v-if=loading class="loader">
    <img src="/static/img/ripple.svg" />
  </div>

  <div class="jumbotron bg-light text-muted w-100"  v-if="!numResults && numResults !== 0">
    <div class="jumbotron">

    <h1 class="mb-5">Search {{site_name}}</h1>
    <form class="row" @submit.prevent="search(query, 'queryChanged')">
      <input id="search-query" type="search" v-model='query' name="query" class="form-control mb-4 col-lg-4 col-md-6" placeholder="search datasets">
    </form>
    </div>
  </div>

  <div class="jumbotron bg-light text-muted w-100"  v-if="numResults || numResults === 0">
    <form class="row" @submit.prevent="search(query, 'queryChanged')">
      <input id="search-query" type="search" v-model='query' name="query" class="form-control mb-4 col-lg-4 col-md-6" placeholder="search datasets">
    </form>

    <div id="results-count" class="d-flex align-items-center mb-2 justify-content-between">
      <h3 id="num-results">
        <template v-if="numResults">
          <span v-text="selectedMin"></span><span>-</span><span v-text="selectedMax"></span><span> of </span>
        </template>
        <span v-if="numResults === 10000"> over </span>
        <span v-text="numResults.toLocaleString()"></span>
        <span> results</span>
      </h3>

      <div id="pagination-page-size" class="pagination">
        Show
        <ul>
          <li v-for="(pageSize, index) in paginationOptions" v-if="pageSize <= numResults || index === 0 || paginationOptions[index-1] < numResults" v-bind:class="[ pageSize === selectedPerPage ? 'selected' : 'unselected' ]">
            <a v-text="pageSize" v-on:click="changePageSize(pageSize)"></a>
          </li>
        </ul>
      </div>

    </div>


    <template v-show="results && results.length > 0" v-if="results && results.length > 0">

      <div class="row">
        <!-- facet filters -->
        <div id="filters" class="col-md-3 pr-4">
          <small class="d-flex justify-content-end"><a @click="clearFilters()" href="">clear filters</a></small>
          <form class="facet-group whitefadedarker" v-for="variable in facetSummary" v-if="facetSummary && facetSummary.length > 0" @change.prevent="search(query, 'filtersChanged')">
            <div class="facet-title mb-1" v-text="variable.variable"></div>

            <template v-for="(count, index) in variable.counts" v-if="variable.counts.length > 0">
              <label :for="count.key">
                <input class="facet-counts px-1" type="checkbox" :id="count.key" :value="count.key" :name="count.key" v-model="selectedFilters[variable.variable]">
                <small><span v-html="count.key"></span><span v-text="' (' + count.value + ')'"></span></small>
                <!-- <span class="checkmark"></span> -->
              </label>
            </template>
          </form>
        </div>

        <div id="results" class="col-md-9">
          <div v-for="item in results" class="row py-3 result-summary">
            <div class="col-md-4 text-left">
              <!-- name -->
              <a :href="'/dataset/' + item._id">
                <h5 v-text="item.name" class="row" v-if="item.name"></h5>
                <h5 v-text="'Unnamed dataset'" class="row" v-if="!item.name"></h5>
              </a>

              <!-- other short properties -->
              <div class="dataset-properties">
                <div id="credit" class="row" v-if="item.creator || item.publisher || item.provider">

                  <div id="creator" v-if="item.creator">
                    <template v-if="Array.isArray(item.creator)  && item.creator.length > 0">
                      <span v-text="item.creator[0].name"></span><i> et al.</i>

                    </template>
                    <template v-else>
                      <span v-text="item.creator.name"></span>
                    </template>
                  </div>
                  <div id="author" v-else-if="item.author">
                    <template v-if="Array.isArray(item.author) && item.author.length > 0">
                      <span v-text="item.author[0].name"></span><i> et al.</i>

                    </template>
                    <template v-else>
                      <span v-text="item.author.name"></span>
                    </template>
                  </div>

                  <div id="creator-affiliation" v-text="item.creator[0].affiliation" v-if="item.creator && item.creator[0] && item.creator[0].affiliation">
                  </div>
                  <div id="creator-affiliation" v-text="item.author[0].affiliation" v-else-if="item.author && item.author[0] && item.author[0].affiliation">
                  </div>
                  <div id="publisher" v-text="item.publisher.name" v-else-if="item.publisher"></div>
                  <div id="provider" v-text="item.provider.name" v-else-if="item.provider"></div>

                  <div id="citation" class="citation mainTextDark" v-if="item.citation">
                    <template v-if="Array.isArray(item.citation)">
                      <span v-for="citation in item.citation" v-text="citation"></span>
                    </template>
                    <template v-else>
                      <span v-text="item.citation"></span>
                    </template>
                  </div>

                </div>

                <div id="source">
                  <template v-if="item['_id'].includes('zenodo')">
                    view on <a :href="item.url" target="_blank" rel="noreferrer">Zenodo</a>
                  </template>

                  <template v-if="item['_id'].includes('omicsdi')">
                    view on <a :href="item['_id']" target="_blank" rel="noreferrer">OmicsDI</a>
                  </template>
                  <template v-if="item.includedInDataCatalog && item.includedInDataCatalog.name.includes('NCBI GEO')">
                    view on <a :href="item.distribution.contentUrl" target="_blank" rel="noreferrer">NCBI GEO</a>
                  </template>
                  <template v-if="item.includedInDataCatalog && item.includedInDataCatalog.name.includes('Harvard Dataverse')">
                    view on <a :href="item['@id']" target="_blank" rel="noreferrer">Harvard Dataverse</a>
                  </template>
                </div>


                <div id="dateModified" v-if="item.dateModified"><span style="padding-right:4px">updated</span><span v-text="item.dateModified"></span></div>
                <!-- <div id="dateModified" class="row" v-if="item.dateModified | moment('dddd, MMMM Do YYYY')"><span style="padding-right:4px">updated</span><span v-text="item.dateModified"></span></div> -->
                <div id="datePublished" v-if="item.datePublished"><span style="padding-right:4px">published</span><span v-text="item.datePublished"></span></div>

                <div id="license" v-if="item.license && item.license.text">
                  <a target="_blank" :href="'/'+item.license.url+'/'" v-html="item.license.text">link</a>
                </div>
              </div>
            </div>

            <!-- description -->
            <div class="col-md-8 text-left" id="description" v-if="item.description">
              <a :href="item.distribution.contentUrl" target="_blank" rel="noreferrer" v-if="item.distribution">
              <img class="repo-icon float-right" src="/static/img/repositories/geo.gif" v-if="item.includedInDataCatalog && item.includedInDataCatalog.name.includes('NCBI GEO')"/>
              </a>

              <a :href="item.url" target="_blank" rel="noreferrer">
                <img class="repo-icon float-right" src="/static/img/repositories/zenodo.svg"  v-if="item['_id'].includes('zenodo')" />
              </a>

              <a :href="item['@id']" target="_blank" rel="noreferrer">
                <img class="repo-icon float-right" src="/static/img/repositories/dataverse_small.png" v-if="item.includedInDataCatalog && item.includedInDataCatalog.name.includes('Harvard Dataverse')"/>
              </a>

              <a :href="item['_id']" target="_blank" rel="noreferrer">
              <img class="repo-icon float-right" src="/static/img/repositories/omicsdi.png" v-if="item['_id'].includes('omicsdi')"/>
            </a>

              <template v-if="item.descriptionExpanded">
                <span v-html="item.longDescription"></span>
                <span><a class="show-more" v-if="item.descriptionTooLong" href="#" @click.prevent="item.descriptionExpanded=false">(show less)</a></span>
              </template>
              <template v-else>
                <span v-html="item.shortDescription"></span>
                <span v-if="item.descriptionTooLong">... <a class="show-more" href="#" @click.prevent="item.descriptionExpanded=true">(show more)</a></span>
              </template>
            </div>

            <!-- measurementTechnique -->
            <div class="col-md-12">
              <div class="row d-flex justify-content-end" id="variableMeasured" v-if="item.variableMeasured || item.measurementTechnique">
                <!-- variableMeasured -->
                <template v-if="Array.isArray(item.variableMeasured)">
                  <small :data-tippy-info='`Search for "${measurement}"`' class="launch-search measurement mainBackDark" v-text="measurement" v-for="measurement in item.variableMeasured" @click.prevent="search(measurement, 'queryChanged', true)">
                  </small>
                </template>
                <small :data-tippy-info='`Search for "${item.variableMeasured}"`' class="launch-search measurement mainBackDark" v-else v-text="item.variableMeasured" v-if="item.variableMeasured" @click.prevent="search(item.variableMeasured, 'queryChanged', true)">
                </small>

                <!-- measurementTechnique -->
                <template v-if="Array.isArray(item.measurementTechnique)">
                  <small :data-tippy-info='`Search for "${measurement}"`' class="launch-search measurement mainBackDark" v-text="measurement" v-for="measurement in item.measurementTechnique" @click.prevent="search(measurement, 'queryChanged', true)">
                  </small>
                </template>
                <small :data-tippy-info='`Search for "${item.measurementTechnique}"`' class="launch-search measurement mainBackDark" v-else v-text="item.measurementTechnique" v-if="item.measurementTechnique" @click.prevent="search(item.measurementTechnique, 'queryChanged', true)">
                </small>
              </div>
            </div>

            <!-- keywords -->
            <div class="col-md-12">
              <div class="row d-flex justify-content-end" id="keywords" v-if="item.keywords">
                <template v-if="Array.isArray(item.keywords)">
                  <small :data-tippy-info='`Search for "${keyword}"`' class="launch-search keyword keyword-arr mainBackLight" v-text="keyword" v-for="keyword in item.keywords" @click.prevent="search(keyword, 'queryChanged', true)">
                  </small>
                </template>
                <small :data-tippy-info='`Search for "${item.keywords}"`' class="launch-search keyword keyword-str mainBackLight" v-text="item.keywords" @click.prevent="search(item.keywords, 'queryChanged', true)" v-else>
                </small>
              </div>
            </div>
          </div>

        </div>

      </div>
  </div>

  <nav class="row m-auto d-flex justify-content-center" id="pagination">
    <ul class="pagination m-2 flex-wrap p-2">
      <li class="page-item" :class="{ 'disabled': selectedPage <= 1 }">
        <a class="page-link" @click.prevent="prevPage()">&lt;</a>
      </li>
      <li class="page-item" :class="{ 'active': selectedPage == 1, 'bg-primary': selectedPage == 1, 'white-text': selectedPage == 1  }">
        <a href="#" class="page-link" @click.prevent="changePageNumber(1)">1</a>
      </li>
      <li class="page-item disabled" v-if="selectedPage > 3 && pages > 4">
        ...
      </li>
      <li class="page-item" :class="{ 'active': selectedPage == n, 'bg-primary': selectedPage == n, 'white-text': selectedPage == n  }" v-for="n in pages"
        v-if="n !== 1 && n !== pages && ((n >= selectedPage - 1 && n <= selectedPage + 1) || (n <=4 && selectedPage <= n) || (n >= pages - 3 && selectedPage >= pages - 1))">
        <a href="#" class="page-link" @click.prevent="changePageNumber(n)" v-text="n"></a>
      </li>
      <li class="page-item disabled" v-if="(selectedPage < pages - 2) && pages > 4">
        ...
      </li>
      <li class="page-item" :class="{ 'active': selectedPage == pages, 'bg-primary': selectedPage == pages, 'white-text': selectedPage == pages  }" v-if="pages !== 1">
        <a href="#" class="page-link" @click.prevent="changePageNumber(pages)" v-text="pages"></a>
      </li>
      <li class="page-item" :class="{ 'disabled': selectedPage >= pages }">
        <a class="page-link" @click.prevent="nextPage()">&gt;</a>
      </li>
    </ul>
  </nav>
  </template>


</div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/vuex"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.4.2/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
<script src="https://unpkg.com/vue-router"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="/static/js/clean-facets.js"></script>
<script src="https://unpkg.com/tippy.js@3/dist/tippy.all.min.js"></script>
<!-- <script src="https://cdn.jsdelivr.net/npm/sweetalert2@7.28.11/dist/sweetalert2.all.min.js"></script> -->
<script>

  var router = new VueRouter({
    mode: 'history',
    routes: [{
      path: '/search/:q',
      component: app,
      props: (route) => ({
        query: route.query.q
      })
    }],
  });

  const store = new Vuex.Store({
    state: {
      'metadata': {},
    },
    strict: true,
    mutations: {
      saveMetadata(state, payload) {
        state.metadata = payload['metadata']
      },
    },
    getters: {
      // exposed as store.getters.nameOfGetter
      getMetadata: state => {
        return state.metadata
      },
    }
  });

  var app = new Vue({
    el: '#search-results',
    router: router,
    data: function() {
      return {
        query: "",
        loading: false,
        paginationOptions: [10, 25, 50],
        defaultPerPage: 10,
        selectedPerPage: 10,
        selectedPage: 1,
        numResults: null,
        results: [],
        pages: 1,
        facetSize: 5,
        facets: ["funder.name.keyword", "funding.funder.name.keyword", "variableMeasured.keyword", "measurementTechnique.keyword", "keywords.keyword"],
        facetSummary: [],
        selectedFilters: {
          "funder": [],
          "variableMeasured": [],
          "measurementTechnique": [],
          "keywords": []
        },
        maxDescriptionLength: 75,
        loading: false,
        scripttext: ''
      }
    },
    computed: {
      selectedMin: function() {
      return (this.selectedPage - 1) * this.selectedPerPage + 1;
    },
      selectedMax: function() {
        var maxValue = this.selectedPage * this.selectedPerPage;
      return maxValue <= this.numResults ? maxValue : this.numResults;
    }

    },
    watch: {
      $route(to, from) {
        this.executeSearch();
      }
    },
    mounted: function() {
      this.executeSearch();


      tippy( 'body',{
      target:'.launch-search',
      content: 'Loading...',
      maxWidth:'200px',
      placement:'bottom',
      animation: 'fade',
      theme:'light',
      onShow(instance) {
      let info = instance.reference.dataset.tippyInfo;
      instance.setContent("<div class='text-muted m-0'>"+info+"</div>")
      }
      });
    },
    methods: {
      clearFilters() {
        this.selectedFilters = {
                "funder": [],
                "variableMeasured": [],
                "measurementTechnique": [],
                "keywords": []
              };

        this.search(this.query, 'filtersChanged');
      },
      changePageSize(selectedSize) {
        let self = this;
        self.selectedPerPage = selectedSize;

        self.search(self.query, "pageChanged");
      },
      changePageNumber(pageNumber) {
        let self = this;
        self.selectedPage = pageNumber;

        self.search(self.query, "pageChanged");
      },
      calculatePages: function() {
        var self = this;
        self.pages = Math.ceil(self.numResults / self.selectedPerPage);
      },
      prevPage: function() {
        var self = this;
        if (self.selectedPage > 1)
          self.selectedPage -= 1
        self.search(self.query, "pageChanged");
      },
      nextPage: function() {
        var self = this;
        if (self.selectedPage < self.pages)
          self.selectedPage += 1
        self.search(self.query, "pageChanged");
      },
      search(query, queryType, enquoteQuery = false) {
        var self = this;
        // reset pagination, filters if there's a new query
        if (queryType === "queryChanged") {
          self.query = query;
          self.selectedPerPage = self.defaultPerPage;
          self.selectedPage = 1;
          self.selectedFilters = {
            "funder": [],
            "variableMeasured": [],
            "measurementTechnique": [],
            "keywords": []
          }
        } else if (queryType === "filtersChanged") {
          self.selectedPerPage = self.defaultPerPage;
          self.selectedPage = 1;
        } else if (queryType === "pageChanged") {}

        <!-- var queryText = query ? (enquoteQuery ? `"${query}"` : query) : "__all__"; -->

        console.log(self.selectedFilters)

        if (query) {
          // update route url
        this.$router.push({path: "/search", query: { q: self.query, filters: getQueryFilters(self.selectedFilters), size: self.selectedPerPage, from: self.selectedPage}}).catch(err => {
        });
        }
      },
      executeSearch() {
        var self = this;
        self.query = self.$route.query.q;

        if(self.query){
        self.selectedPerPage = self.$route.query.size ? self.$route.query.size : self.defaultPerPage;
        self.selectedPage = self.$route.query.from ? self.$route.query.from : 1;

        var queryText = self.query ? self.query : "__all__";
        <!-- var queryText = query ? (enquoteQuery ? `"${query}"` : query) : "__all__"; -->

        // pull out the applied filter string and convert to an object.
        self.selectedFilters = filterString2Obj(self.$route.query.filters);

        // if (Object.values(self.selectedFilters).flatMap(d => d).length > 0) {
        // let selectedFilters = getQueryFilters(self.selectedFilters);
        if(self.$route.query.filters) {
          queryText = queryText === "__all__" ? selectedFilters : `${queryText} AND ${self.$route.query.filters}`
        }

        var params = {
          "params": {
            "q": queryText,
            "size": self.selectedPerPage,
            "from": (self.selectedPage - 1) * self.selectedPerPage,
          }
        };

        var facetParams = {
          "params": {
            "q": queryText,
            "facet_size": this.facetSize,
            "facets": this.facets.join(","),
          }
        };

        self.loading = true;

        self.results = [];

        // TODO: set in config
        axios.get("{{api_url}}" + 'query?', params).then(function(response) {
          console.log(`%c searching ${self.query}...`, 'color:hotpink')
          console.log(response.data.hits)

          // Standardize descriptions. NOTE: needs to be done before assign to <this> to ensure proper change detection.
          response.data.hits.forEach(d => {
            if (Array.isArray(d.description)) {
              d['longDescription'] = d.description.join("<br/>");
            } else {
              d['longDescription'] = d.description;
            }
            let descriptionArray = d.longDescription.split(" ");
            d['shortDescription'] = descriptionArray.slice(0, self.maxDescriptionLength).join(" ");
            d['descriptionTooLong'] = descriptionArray.length >= self.maxDescriptionLength;
            d['descriptionExpanded'] = false;
          })

          self.results = response.data.hits;
          self.numResults = response.data.total.value;

          if (self.numResults) {
            self.calculatePages();
          }

          self.loading = false;
        });

        // TODO: promise-ize this.
        axios.get("{{api_url}}" + 'query?', facetParams).then(function(response) {
          let allResults = cleanFacets(response.data.facets, self.facetSize);

          console.log(allResults)
          self.facetSummary = allResults;
          self.loading = false;
        });
}

      }
    }
  });
</script>
<style>
  #results-count h1 {
    margin-bottom: 0;
  }

  .pagination {
    display: inline-flex;
  }

  .pagination ul {
    list-style-type: none;
    margin-bottom: 0;
  }

  .pagination li {
    display: inline-block;
    margin-right: 5px;
    cursor: pointer;
  }

  #pagination-page-size li {
    margin-right: 25px;
  }

  .result-summary:first-of-type {
    padding-top: 0 !important;
  }

  .result-summary {
    border-bottom: 1px solid #BBB;
  }

  .selected {
    font-weight: bold;
  }

  .unselected {
    font-weight: 300;
  }

  .disabled {
    opacity: 0.5;
  }

  .keyword,
  .measurement {
    padding: 3px 5px;
    border-radius: 0.3em;
    margin-left: 0.5em;
    margin-bottom: 0.5em;
    font-size: 0.75em;
    cursor: pointer;
  }

  .dataset-properties {
    font-size: 0.85em;
  }

  .measurement {
    color: white;
  }

  .citation {
    line-height: 1.2em;
  }

  #credit {
    border-bottom: 1px dashed #bbb;
    padding-bottom: 2px;
    margin-bottom: 5px;
    flex-direction: column;
  }

  .facet-group {
    margin-bottom: 15px;
    border-top: 1px solid;
    border-bottom: 1px solid;
  }

  .facet-title {
    font-size: 0.9em;
    font-weight: 400;
    background: #ddd;
    border-bottom: 1px solid;
  }

  .facet-title,
  .facet-group label {
    padding: 0 0.5em;
  }

  .facet-counts {
    line-height: .8em;
    margin-bottom: 0.4em;
  }

  .facet-counts small {
    font-weight: 300;
  }

  .repo-icon {
    height: 30px;
  }
</style>
{% include "footer.html" %}
{% endblock %}
